<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="cn" lang="cn">
<head>
  <link href="//gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.49" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>gitlab runner &#43; docker 自动构建 &middot; Gravel</title>

  
  <link type="text/css" rel="stylesheet" href="https://leongravel.com/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://leongravel.com/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://leongravel.com/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://leongravel.com/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Gravel" />

  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://leongravel.com/"><h1>Gravel</h1></a>
      <p class="lead">
       A Empty-Stack Developer.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://leongravel.com/">Home</a> </li>
        <li><a href="/posts/"> Posts </a></li><li><a href="/portfolio/"> Portfolio </a></li><li><a href="/about/about"> About </a></li>
      </ul>
    </nav>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>gitlab runner &#43; docker 自动构建</h1>
  <time datetime=2018-09-11T23:01:41Z class="post-date">Tue, Sep 11, 2018</time>
  <p>最开始的时候，我尝试Jenkins+docker，可是Jenkins的docker依赖和插件，实在太过麻烦，配置项等等，太重。所以我转为使用gitlab runner来实现自动构建并打包镜像。</p>

<p></p>

<h2 id="准备工作">准备工作</h2>

<ul>
<li>安装docker</li>
<li>在docker同一个机器上安装gitlab runner</li>
<li>配置.gitlab-ci.yml</li>
</ul>

<h3 id="安装docker">安装Docker</h3>

<p>参考官方文档，唯一需要注意的是，需要将镜像仓库地址修改为私有的地址。可以通过配置Deamon.json实现。具体配置如下。
<code>registry-mirrors</code>代表私有仓库地址，<code>insecure-registries</code>的作用是，push指向的地址。
&gt; Docker自从1.3.X之后docker registry交互默认使用的是HTTPS，所以这里最好直接指定仓库地址，不然push的时候会报错。</p>

<pre><code>{
  &quot;registry-mirrors&quot;: [
    &quot;http://registry.******.com:5000&quot;
  ],
  &quot;insecure-registries&quot;: [
    &quot;registry.******.com:5000&quot;
  ],
  &quot;debug&quot;: true,
  &quot;experimental&quot;: false
}
</code></pre>

<h3 id="安装gitlab-runner">安装gitlab runner</h3>

<p>服务器是centos 7,以下的步骤都是基于centos 7</p>

<h4 id="下载二进制安装文件">下载二进制安装文件</h4>

<pre><code>curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | sudo bash
</code></pre>

<h4 id="安装">安装</h4>

<pre><code>sudo yum install gitlab-runner
</code></pre>

<h4 id="注册runner">注册Runner</h4>

<pre><code>sudo gitlab-runner register
</code></pre>

<ol>
<li><p>填入填入私有gitlab的url</p>

<pre><code>Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com )
https://gitlab.******.com
</code></pre></li>

<li><p>输入项目的gitlab token</p>

<pre><code>Please enter the gitlab-ci token for this runner
xxx
</code></pre></li>

<li><p>添加runner描述</p>

<pre><code>Please enter the gitlab-ci description for this runner
jiedu-ci
</code></pre></li>

<li><p>添加描述标签，若添加多个需用逗号隔开</p>

<pre><code>Please enter the gitlab-ci tags for this runner (comma separated):
ci,shws,jiedu
</code></pre></li>

<li><p>选择runner 运行模式
这里我选择的Docker，因为我们要使用docker 镜像以及一些其他的镜像</p></li>
</ol>

<blockquote>
<p>其他的我也不是很了解</p>
</blockquote>

<pre><code>Please enter the executor: ssh, docker+machine, docker-ssh+machine, kubernetes, docker, parallels, virtualbox, docker-ssh, shell:
docker
</code></pre>

<ol>
<li>设置基础镜像
<code>
Please enter the Docker image (eg. ruby:2.1):
registry.******.com:5000/dzjz/ci/maven
</code></li>
</ol>

<h4 id="配置gitlab-runner">配置gitlab runner</h4>

<pre><code>vi /etc/gitlab-runner/config.toml
</code></pre>

<p>写入</p>

<pre><code>concurrent = 1
check_interval = 0
environment = [&quot;MAVEN_HOME=/path/to/maven&quot;]
[[runners]]
  name = &quot;shws-ci&quot;
  url = &quot;http://gitlab.******.com&quot;
  token = &quot;234234*******************&quot;
  executor = &quot;docker&quot;
  output_limit = 208192
  [runners.docker]
    tls_verify = false
    image = &quot;registry.******.com:5000/dzjz/ci/maven&quot;
    privileged = true
    cache_dir = &quot;cache&quot;
    disable_cache = false
     volumes = [&quot;/var/run/docker.sock:/var/run/docker.sock&quot;, &quot;/cache&quot;,&quot;/root/.m2:/root/.m2&quot;]
    shm_size = 0
    pull_policy = &quot;if-not-present&quot;
  [runners.cache]

</code></pre>

<p>当然这个部分后期会进一步完善修改，目前只是一个示例。</p>

<h3 id="配置-gitlab-ci-yml">配置.gitlab-ci.yml</h3>

<p>这一部分，具体可以参考官方文档以及<a href="https://segmentfault.com/a/1190000011890710">这篇</a>，项目的配置如下：</p>

<pre><code># 定义stages
stages:
  - build
  - push
  


# 构建各个依赖组件的jar包，并复制Dockerfile对应位置等待构建.
build-job:
  #  image: registry.******.com:5000/dzjz/ci/maven
    stage: build
    only:
        - feature/20180428-1.0.0.0script1-第二版

    script:
        - mkdir -p jd-ci/shws/kf
        - cd shws/ &amp;&amp; pwd
        - mvn clean install -U
        - echo '准备发布生活卫生镜像到私有镜像仓库！'
        - rm -rf src/dockerfile/*.war
        - cd .. &amp;&amp; pwd
        - cp -r shws/target/shws.war shws/src/dockerfile/Dockerfile jd-ci/shws/kf
        - cd jd-ci/shws/kf/ &amp;&amp; ls
    ## 下面这个配置的作用是在不同的job间传递共享war包以及Dockerfile
    artifacts:
      name:  &quot;${CI_REGISTRY_IMAGE}:${CI_COMMIT_REF_SLUG}&quot;
      paths:
        - jd-ci/shws/kf/*
      expire_in: 1 day


push-job:
  stage: push
  only:
    - feature/20180428-1.0.0.0script1-第二版
  image: registry.******.com:5000/docker:latest
  services: 
    - registry.******.com:5000/docker:dind
  before_script:
  - docker info
  script:
    - echo '准备构建镜像并push到私有仓库'
    #- cd ./jd/shws/kf/ &amp;&amp; ls
    - docker stop shws-kf || true
    - docker rm -f shws-kf || true
    - docker rmi registry.******.com:5000/cdjd/shws-kf || true
    - docker build -t registry.******.com:5000/cdjd/shws-kf ./jd-ci/shws/kf/
    - docker push registry.******.com:5000/cdjd/shws-kf
    - rm -rf jd-ci/shws/kf

</code></pre>

<p>这个配置文件中，<code>only</code>部分代表你的分支，script部分代表对应的脚本。其他业务系统需要替换的东西（比如构建镜像的名字，缓存的名称，这些可以自定义）。</p>

<h3 id="结束">结束</h3>

<p>以上就是gitlab runner + docker实现自动构建打包镜像并上传的简单教程。</p>
</div>

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "leongravel" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </main>

    
  </body>
</html>
